name: 'CI - Build, Scan, Push and Trigger CD'
'on':
  push:
    branches:
      - main
      - dev
      - rc-*
      - feature/*
  pull_request:
    branches:
      - main
      - dev
      - rc-*
  workflow_dispatch: null
permissions:
  id-token: write
  contents: read
env:
  AWS_REGION: '${{ secrets.AWS_REGION }}'
  AWS_ACCOUNT_ID: '${{ secrets.AWS_ACCOUNT_ID }}'
  SONAR_TOKEN: '${{ secrets.SONAR_TOKEN }}'
  PERSONAL_ACCESS_TOKEN: '${{ secrets.PERSONAL_ACCESS_TOKEN }}'
  REPO_DEPLOY: '${{ secrets.REPO_DEPLOY }}'
  ECR_REGISTRY: >-
    ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION
    }}.amazonaws.com
  REPO_NAME: '${{ secrets.REPO_NAME }}'
jobs:
  detect-branch:
    runs-on: ubuntu-latest
    outputs:
      is-first-push: '${{ steps.check.outputs.is_first_push }}'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Vérifier si la branche existe déjà sur remote
        id: check
        run: >
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"

          # Vérifie si la branche existe déjà sur remote

          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q
          "$BRANCH_NAME"; then
            echo "is_first_push=false" >> $GITHUB_OUTPUT
          else
            echo "is_first_push=true" >> $GITHUB_OUTPUT
          fi
  verify:
    needs: detect-branch
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: temurin
      - name: Build and run tests
        run: mvn clean install
  build-push:
    needs: verify
    runs-on: ubuntu-latest
    if: ${{ needs.detect-branch.outputs.is-first-push == 'false' || github.event_name == 'pull_request' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: 'arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/GitHubActionsECRRole'
          aws-region: '${{ env.AWS_REGION }}'

      - name: Set environment tag with date
        run: |
          SHA=$(echo "${GITHUB_SHA}" | cut -c1-8)
          DATE=$(date +%Y%m%d-%H%M%S)

          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            BASE="${GITHUB_BASE_REF}"
            if [[ "$BASE" == "dev" ]]; then
              ENV="feature"
              TAG="user-feature-${SHA}-${DATE}"
            elif [[ "$BASE" == rc-* ]]; then
              ENV="staging"
              TAG="user-staging-${SHA}-${DATE}"
            elif [[ "$BASE" == "main" ]]; then
              ENV="prod"
              TAG="user-prod-${SHA}-${DATE}"
            else
              ENV="dev"
              TAG="user-dev-${SHA}-${DATE}"
            fi
          elif [[ "${GITHUB_EVENT_NAME}" == "push" ]]; then
            REF="${GITHUB_REF}"
            if [[ "$REF" == "refs/heads/dev" ]]; then
              ENV="dev"
              TAG="user-dev-${SHA}-${DATE}"
            elif [[ "$REF" == refs/heads/rc-* ]]; then
              ENV="staging"
              TAG="user-staging-${SHA}-${DATE}"
            elif [[ "$REF" == "refs/heads/main" ]]; then
              ENV="prod"
              TAG="user-prod-${SHA}-${DATE}"
            elif [[ "$REF" == refs/heads/feature/* ]]; then
              ENV="dev"
              TAG="user-dev-${SHA}-${DATE}"
            else
              ENV="unknown"
              TAG="user-unknown-${SHA}-${DATE}"
            fi
          else
            ENV="dev"
            TAG="user-dev-${SHA}-${DATE}"
          fi

          echo "ENV=$ENV" >> $GITHUB_ENV
          echo "TAG=$TAG" >> $GITHUB_ENV

      - name: Build Docker image
        run: docker build -t $ECR_REGISTRY/${{ env.REPO_NAME }}:${{ env.TAG }} .

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v1
        with:
          mask-password: true

      - name: Push Docker image
        run: docker push $ECR_REGISTRY/${{ env.REPO_NAME }}:${{ env.TAG }}